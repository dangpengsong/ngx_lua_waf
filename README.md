# ngx_lua_waf

基于 OpenResty (ngx_lua) 的高性能 Web 应用防火墙，采用 Lua 脚本实现请求过滤与安全防护。

---

## 核心防护能力

| 防护类型 | 说明 |
|---------|------|
| **SQL 注入** | 拦截 Union/报错注入/盲注/时间延迟注入等多种攻击方式 |
| **XSS 攻击** | 检测 Script/事件处理器/JavaScript 伪协议等跨站脚本 |
| **远程代码执行** | 拦截 PHP/Java/Python 等危险函数调用与反序列化攻击 |
| **目录遍历** | 阻止 `../` 路径穿越和敏感文件读取 |
| **文件上传** | 屏蔽 php/jsp/asp/exe/sh 等危险后缀文件上传 |
| **SSRF 攻击** | 拦截 gopher/file/dict/ldap 等协议伪造请求 |
| **扫描器识别** | 检测 sqlmap/nmap/nikto/nuclei 等安全工具特征 |
| **CC 攻击** | 基于 IP+URI 的请求频率限制 |
| **信息泄露** | 拦截 .git/.svn/备份文件/敏感配置 等路径访问 |

---

## 功能模块架构

```
请求入口
    │
    ▼
┌─────────────────┐
│  IP 白名单检测   │ ─── 命中 ──→ 放行
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  IP 黑名单检测   │ ─── 命中 ──→ 拦截(403)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  URL 白名单检测  │ ─── 命中 ──→ 放行
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   CC 频率限制    │ ─── 超限 ──→ 拦截(403)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ HTTP 方法/Host校验│ ─── 异常 ──→ 拦截(403)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  扫描器指纹检测   │ ─── 命中 ──→ 拦截(403)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  静态特征检测    │  UA / URL / Args / Cookie / Headers / Referer
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  POST 深度检测   │  表单参数 / Multipart 文件上传
└────────┬────────┘
         │
         ▼
      放行请求
```

---

## 运行环境要求

| 组件 | 版本要求 |
|------|---------|
| OpenResty / Nginx | 支持 ngx_lua 模块 |
| ngx_lua | ≥ 0.9.2（推荐使用 `ngx.re.find` 提升性能） |
| LuaJIT | 2.1（非标准 Lua 解释器） |

---

## 部署配置

### 目录结构

```
waf/
├── config.lua      # 核心配置文件
├── init.lua        # 初始化与规则加载
├── waf.lua         # 请求过滤主逻辑
└── wafconf/        # 规则目录
    ├── args        # GET 参数过滤规则
    ├── url         # URL 路径过滤规则
    ├── post        # POST 数据过滤规则
    ├── cookie      # Cookie 过滤规则
    ├── user-agent  # User-Agent 过滤规则
    └── whiteurl    # URL 白名单规则
```

### Nginx 配置要点

在 `nginx.conf` 的 `http` 段添加以下指令：

| 指令 | 用途 |
|------|------|
| `lua_package_path` | 指定 Lua 脚本搜索路径 |
| `lua_shared_dict limit 10m` | CC 防护计数器共享内存（必须配置） |
| `init_by_lua_file` | 加载 init.lua 进行规则预热 |
| `access_by_lua_file` | 加载 waf.lua 执行请求过滤 |

### 关键配置项说明

| 配置项 | 类型 | 说明 |
|--------|------|------|
| `rulepath` | 路径 | 规则文件目录（确保末尾带斜杠） |
| `logdir` | 路径 | 攻击日志存储目录（需 nginx 用户可写） |
| `attacklog` | on/off | 是否记录攻击日志 |
| `url_deny` | on/off | 是否开启 URL 过滤 |
| `cookie_match` | on/off | 是否开启 Cookie 过滤 |
| `post_match` | on/off | 是否开启 POST 过滤 |
| `cc_deny` | on/off | 是否开启 CC 防护 |
| `cc_rate` | 格式 | 频率限制（如 `100/60` = 60秒内100次） |
| `ipWhitelist` | 数组 | IP 白名单列表 |
| `ipBlocklist` | 数组 | IP 黑名单列表 |
| `black_fileext` | 数组 | 禁止上传的文件后缀 |

---

## 规则文件格式

- 每行一条正则表达式规则
- 以 `#` 开头的行为注释，自动忽略
- 空行自动跳过
- 正则语法遵循 PCRE 标准（支持 `\b` 单词边界、`(?i)` 忽略大小写等）

---

## 日志格式

攻击日志文件名：`{虚拟主机名}_{日期}_sec.log`

日志字段：
```
IP [时间] 攻击类型 主机名+URI "触发数据" "匹配规则" "User-Agent"
```

攻击类型标识：
- `IP` - IP 黑名单命中
- `CC` - CC 攻击触发
- `UA` - User-Agent 异常
- `URL` - URL 规则命中
- `Cookie` - Cookie 注入
- `UPLOAD` - 危险文件上传
- `SCANNER` - 扫描器指纹
- `METHOD` - 异常 HTTP 方法
- `HOST` - Host 头异常

---

## 验证部署

部署完成后，可通过以下方式验证规则是否生效：

1. **SQL 注入测试**：访问包含 `union select` 的 URL
2. **路径遍历测试**：访问包含 `../etc/passwd` 的 URL
3. **扫描器测试**：使用 sqlmap 等工具发起请求

成功拦截时将返回 403 状态码及自定义拦截页面。

> 注意：本机 IP（127.0.0.1）默认在白名单中，不会触发过滤。

---

## 性能优化建议

| 优化点 | 说明 |
|--------|------|
| 使用 LuaJIT 2.1 | 相比标准 Lua 性能提升显著 |
| 规则预编译 | 规则在 init 阶段加载，运行时无 IO 开销 |
| IP 列表 Hash 化 | IP 白/黑名单使用 Hash 表 O(1) 查询 |
| 异步日志写入 | 使用 `ngx.timer.at` 异步写日志，不阻塞请求 |
| 共享内存计数 | CC 防护使用 `lua_shared_dict` 高效计数 |

---

## 许可协议

MIT License

